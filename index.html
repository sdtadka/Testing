<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Secure Connect</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

<style>
body{background:#000;color:#fff;overflow:hidden}
.glass{background:rgba(20,20,20,.65);backdrop-filter:blur(18px);border:1px solid rgba(255,255,255,.08)}
.input{background:rgba(0,0,0,.6);border:1px solid #333}
.input:focus{border-color:#06b6d4;box-shadow:0 0 12px rgba(6,182,212,.3)}
#toast-box{position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:1000;width:90%;max-width:380px}
.toast{background:#111;border-left:4px solid #06b6d4;padding:12px;border-radius:6px;margin-bottom:10px}
</style>
</head>

<body>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbyiz_A075mO5pfqYXrJgTqNPfBBGICYNK0WNB1OxCuUHOdHX9jWClkymR1NNMD-M2uB/exec";
</script>

<div id="toast-box"></div>

<div class="w-full h-screen flex items-center justify-center">

<!-- LOGIN -->
<div id="login" class="glass p-8 rounded-3xl w-80 animate__animated animate__fadeIn">
  <div class="text-center mb-6">
    <span class="material-icons text-6xl text-cyan-400">fingerprint</span>
    <h1 class="text-xl font-bold tracking-widest mt-2">SECURE ACCESS</h1>
    <p class="text-xs text-gray-400">Authorization Required</p>
  </div>

  <input id="email" type="email" placeholder="Email" class="input w-full p-3 rounded-xl mb-3 outline-none">
  <input id="password" type="password" placeholder="Password" class="input w-full p-3 rounded-xl outline-none">

  <button id="loginBtn" onclick="login()" class="w-full mt-5 bg-gradient-to-r from-cyan-600 to-blue-600 p-4 rounded-xl font-bold tracking-widest">
    ENTER
  </button>
</div>

<!-- WAIT -->
<div id="wait" class="hidden flex flex-col items-center text-center">
  <div class="w-24 h-24 border-4 border-cyan-500 border-t-transparent rounded-full animate-spin mb-6"></div>
  <h2 class="text-xl font-bold">Waiting for approval</h2>
</div>

<!-- ADMIN -->
<div id="admin" class="hidden fixed top-4 right-4 glass p-4 rounded-xl w-64">
  <h3 class="text-xs text-cyan-400 font-bold mb-2">WAITING USERS</h3>
  <div id="users" class="space-y-2"></div>
</div>

<!-- VIDEO -->
<div id="video" class="hidden absolute inset-0 bg-black">
  <video id="remote" autoplay playsinline class="w-full h-full object-cover"></video>
  <video id="local" autoplay muted playsinline class="absolute bottom-4 right-4 w-36 rounded-xl border border-gray-600"></video>
</div>

</div>

<script>
let user={},peer,stream;
const HOST="SECURE_ADMIN_MASTER_ID_V1";

function toast(msg,color="#06b6d4"){
  const t=document.createElement("div");
  t.className="toast";
  t.style.borderLeftColor=color;
  t.innerText=msg;
  document.getElementById("toast-box").appendChild(t);
  setTimeout(()=>t.remove(),3000);
}

async function api(action,payload){
  const r=await fetch(API_URL,{
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body:JSON.stringify({action,payload})
  });
  return r.json();
}

async function login(){
  const emailVal = document.getElementById("email").value.trim();
  const passVal  = document.getElementById("password").value.trim();
  const btn = document.getElementById("loginBtn");

  if(!emailVal || !passVal){
    toast("Enter credentials","#ef4444");
    return;
  }

  btn.disabled=true;
  btn.innerText="VERIFYING...";

  const r = await api("login",{ email:emailVal, password:passVal });

  if(!r || !r.success){
    toast("Access denied","#ef4444");
    btn.disabled=false;
    btn.innerText="ENTER";
    return;
  }

  user={ email:emailVal, role:r.role };

  document.getElementById("login").classList.add("hidden");

  if(r.role==="admin"){
    document.getElementById("video").classList.remove("hidden");
    document.getElementById("admin").classList.remove("hidden");
    initPeer(HOST);
  } else {
    document.getElementById("wait").classList.remove("hidden");
    pollClient();
  }
}

function pollClient(){
  const i=setInterval(async()=>{
    const r=await api("check_status",{email:user.email});
    if(r.status==="approved"){
      clearInterval(i);
      document.getElementById("wait").classList.add("hidden");
      document.getElementById("video").classList.remove("hidden");
      initPeer(null,true);
    }
  },3000);
}

function initPeer(id,call=false){
  navigator.mediaDevices.getUserMedia({video:true,audio:true}).then(s=>{
    stream=s;
    document.getElementById("local").srcObject=s;
    peer=new Peer(id);
    peer.on("open",()=>{ if(call) peer.call(HOST,s); });
    peer.on("call",c=>{
      c.answer(s);
      c.on("stream",rs=>document.getElementById("remote").srcObject=rs);
    });
  });
}
</script>

</body>
</html>
