<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
  <title>GeoFace AI | Enterprise Master</title>

  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root {
      --bg-body: #f8fafc;
      --bg-card: #ffffff;
      --primary: #00c853; 
      --accent: #2979ff;
      --dark: #1e293b;
      --border: #e2e8f0;
      --shadow: 0 10px 25px -5px rgba(0,0,0,0.08);
    }

    body { background: var(--bg-body); color: var(--dark); font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
    .hidden { display: none !important; }

    /* --- UI CARDS --- */
    .app-card { background: white; border-radius: 24px; padding: 20px; border: 1px solid var(--border); box-shadow: var(--shadow); margin-bottom: 20px; }
    
    .hero-board {
      background: linear-gradient(135deg, var(--dark) 0%, #334155 100%);
      color: white; border-radius: 28px; padding: 25px; margin-bottom: 20px; box-shadow: 0 15px 30px rgba(15, 23, 42, 0.2);
    }

    /* --- DP & BIOMETRIC UI --- */
    .profile-wrap {
      width: 100px; height: 100px; margin: 0 auto; position: relative;
      border-radius: 50%; padding: 4px; background: linear-gradient(135deg, var(--primary), var(--accent));
      cursor: pointer; transition: transform 0.3s ease;
    }
    .profile-wrap:hover { transform: scale(1.05); }
    .profile-img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; border: 4px solid white; background: #f1f5f9; }
    .edit-badge { position: absolute; bottom: 5px; right: 5px; background: white; color: var(--dark); width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 8px rgba(0,0,0,0.1); font-size: 12px; }

    /* --- BUTTONS --- */
    .btn-main { border-radius: 16px; padding: 15px; font-weight: 700; transition: 0.3s; border: none; width: 100%; cursor: pointer; }
    .btn-primary-custom { background: var(--primary); color: white; box-shadow: 0 8px 20px rgba(0, 200, 83, 0.25); }
    .btn-primary-custom:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 12px 25px rgba(0, 200, 83, 0.35); }

    /* --- TABLES --- */
    .user-thumb { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid var(--border); }
    .status-badge { padding: 5px 10px; border-radius: 10px; font-weight: 800; font-size: 10px; text-transform: uppercase; }
    .status-PRESENT { background: #dcfce7; color: #166534; }
    .status-LATE { background: #fee2e2; color: #991b1b; }

    /* --- MODALS --- */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 3000; backdrop-filter: blur(4px); }
    .modal-content-custom { background: white; border-radius: 30px; width: 92%; max-width: 450px; padding: 30px; position: relative; animation: slideUp 0.3s ease-out; }
    @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    .auth-input { background: #f1f5f9; border: 1px solid var(--border); border-radius: 16px; padding: 14px; margin-bottom: 15px; width: 100%; outline: none; font-size: 14px; }
  </style>
</head>
<body>

  <div id="global-loader" class="d-flex justify-content-center align-items-center vh-100 position-fixed w-100" style="background:white; z-index:9999;">
    <div class="text-center"><div class="spinner-grow text-primary"></div><p class="mt-3 fw-bold small">GeoFace AI: Syncing Master...</p></div>
  </div>

  <div id="auth-container" class="d-flex align-items-center justify-content-center vh-100 p-3">
    <div class="app-card w-100 text-center" style="max-width: 420px;">
        <img src="https://i.pinimg.com/280x280_RS/fd/d4/bb/fdd4bb649a0dce691af32001abe18c41.jpg" width="80" class="rounded-circle mb-3 shadow-sm">
        <h4 class="fw-bold mb-4">Enterprise Access</h4>
        
        <div id="login-form">
            <input type="text" id="login-id" class="auth-input" placeholder="Employee ID">
            <input type="password" id="login-pass" class="auth-input" placeholder="Security Password">
            <button onclick="handleLogin()" class="btn-main btn-primary-custom mb-3">SECURE LOGIN</button>
            <div class="d-flex justify-content-between px-2 small">
                <span onclick="handleForgotPass()" class="text-primary fw-bold" style="cursor:pointer">Forgot Password?</span>
                <span onclick="toggleAuth(true)" class="text-success fw-bold" style="cursor:pointer">New Register</span>
            </div>
        </div>

        <div id="register-form" class="hidden">
            <input type="text" id="reg-name" class="auth-input" placeholder="Full Legal Name">
            <input type="number" id="reg-mobile" class="auth-input" placeholder="Mobile Number">
            <button onclick="handleRegister()" class="btn-main btn-primary-custom mb-3">INITIALIZE ENROLLMENT</button>
            <span onclick="toggleAuth(false)" class="small text-muted fw-bold" style="cursor:pointer">Back to Login</span>
        </div>
    </div>
  </div>

  <div id="app-dashboard-container" class="container py-4 hidden">
    <div id="admin-dashboard" class="hidden">
        <div class="hero-board">
            <div class="d-flex justify-content-between align-items-start mb-4">
                <img src="https://i.pinimg.com/280x280_RS/fd/d4/bb/fdd4bb649a0dce691af32001abe18c41.jpg" width="40" class="rounded">
                <div class="profile-wrap" style="width:60px; height:60px; margin:0;" onclick="document.getElementById('dp-upload-admin').click()">
                    <img id="admin-dp" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" class="profile-img">
                </div>
            </div>
            <h3 class="fw-bold">Master Control</h3>
            <p id="admin-welcome-note" class="small opacity-75 fw-bold">Administrator Session Active</p>
            <div class="row g-2 mt-3">
                <div class="col-6"><button onclick="openAdminAddModal()" class="btn btn-light btn-sm w-100 rounded-pill fw-bold">+ Add Staff</button></div>
                <div class="col-6"><button onclick="logout()" class="btn btn-outline-light btn-sm w-100 rounded-pill">Logout</button></div>
            </div>
            <input type="file" id="dp-upload-admin" accept="image/*" hidden onchange="uploadProfilePic(this)">
        </div>
        <div class="app-card">
            <h6 class="fw-bold small mb-3 text-muted">MASTER COMMANDS</h6>
            <div id="admin-gps-status" class="small text-primary mb-3 fw-bold"><i class="fa fa-location-crosshairs"></i> Waiting for GPS...</div>
            <div class="row g-2">
                <div class="col-6"><button id="btn-set-loc" onclick="setOfficeLocation()" class="btn btn-dark btn-sm w-100 rounded-pill py-2" disabled>Set GPS Geofence</button></div>
                <div class="col-6"><button onclick="setOfficeName()" class="btn btn-outline-dark btn-sm w-100 rounded-pill py-2">Location Name</button></div>
            </div>
        </div>
        <div class="app-card">
            <div class="d-flex justify-content-between mb-3">
              <h6 class="fw-bold small">Global Registry</h6>
              <button onclick="downloadReport()" class="btn btn-sm btn-success rounded-pill px-3" style="font-size: 10px;">Export CSV</button>
            </div>
            <div class="table-responsive">
                <table class="table table-sm align-middle" style="font-size: 11px;">
                    <tbody id="admin-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="worker-dashboard" class="hidden">
        <div class="hero-board text-center">
            <div class="profile-wrap shadow" onclick="document.getElementById('dp-upload-worker').click()">
                <img id="worker-dp" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" class="profile-img">
                <div class="edit-badge"><i class="fa fa-camera"></i></div>
            </div>
            <h4 class="fw-bold mt-3" id="worker-name-display">Employee</h4>
            <div id="location-name-display" class="small opacity-75 mt-1 fw-bold">Synchronizing Location...</div>
            <div class="mt-3">
                <h2 class="fw-bold mb-0 text-success" id="total-present">0</h2>
                <p class="small opacity-75 fw-bold">TOTAL LOGS</p>
            </div>
            <input type="file" id="dp-upload-worker" accept="image/*" hidden onchange="uploadProfilePic(this)">
        </div>
        <div class="app-card text-center">
            <div id="worker-gps-status" class="small mb-3 text-muted">Verifying Geofence Access...</div>
            <button id="btn-open-camera" onclick="startCameraFlow()" class="btn-main btn-primary-custom" disabled>
                <i class="fa fa-face-viewfinder me-2"></i> BIOMETRIC CHECK-IN
            </button>
        </div>
        <div class="app-card">
            <h6 class="fw-bold mb-3 small">My Attendance Logs</h6>
            <div class="table-responsive">
                <table class="table table-sm align-middle" style="font-size: 11px;">
                    <tbody id="worker-history-body"></tbody>
                </table>
            </div>
        </div>
        <div class="text-center mt-3"><button onclick="logout()" class="btn btn-link text-danger text-decoration-none fw-bold small">Logout Session</button></div>
    </div>
  </div>

  <div id="admin-add-modal" class="modal-overlay hidden">
      <div class="modal-content-custom">
          <h5 class="fw-bold mb-4 text-center">Provision New Staff</h5>
          <input type="text" id="admin-reg-name" class="auth-input" placeholder="Full Legal Name">
          <input type="number" id="admin-reg-mobile" class="auth-input" placeholder="Mobile Number">
          <select id="admin-reg-role" class="auth-input">
              <option value="Worker">Worker (Field)</option>
              <option value="admin">Admin (Master)</option>
          </select>
          <button onclick="handleAdminAddUser()" class="btn-main btn-primary-custom mt-2">Create Account</button>
          <button onclick="document.getElementById('admin-add-modal').classList.add('hidden')" class="btn btn-link w-100 mt-2 text-muted text-decoration-none small">Dismiss</button>
      </div>
  </div>

  <div id="photo-modal" class="modal-overlay hidden" onclick="this.classList.add('hidden')">
      <div class="text-center">
          <img id="modal-photo-img" src="" class="img-fluid rounded-4 shadow-lg" style="max-height: 75vh; max-width: 90vw; border: 5px solid white;">
          <br><button class="btn btn-light mt-3 px-5 rounded-pill fw-bold">Tap to Close</button>
      </div>
  </div>

  <div id="camera-overlay" class="position-fixed top-0 start-0 w-100 h-100 bg-white d-flex justify-content-center align-items-center hidden" style="z-index: 4000;">
    <div class="text-center w-100 p-4" style="max-width: 500px;">
        <h4 class="fw-bold mb-4">Biometric Face ID</h4>
        <div style="border-radius: 30px; overflow: hidden; position: relative; border: 6px solid #f1f5f9; box-shadow: var(--shadow);">
            <video id="video" autoplay muted playsinline style="width:100%; transform: scaleX(-1);"></video>
            <div id="liveness-hint" class="position-absolute bottom-0 w-100 p-3 bg-dark text-white opacity-75 small fw-bold">Scanning Biometrics...</div>
        </div>
        <button onclick="stopCamera()" class="btn btn-outline-danger w-100 mt-4 rounded-pill fw-bold">Cancel Process</button>
    </div>
  </div>

  <div id="map-modal" class="position-fixed top-0 start-0 w-100 h-100 bg-black bg-opacity-50 hidden" style="z-index: 3100; backdrop-filter:blur(5px);">
    <div class="d-flex justify-content-center align-items-end h-100">
      <div class="bg-white rounded-top-5 w-100" style="height: 85vh; max-width: 600px;">
        <div class="p-4 border-bottom d-flex justify-content-between align-items-center">
            <span class="fw-bold"><i class="fa fa-map-pin text-danger"></i> Geolocation Trace</span>
            <button onclick="document.getElementById('map-modal').classList.add('hidden')" class="btn-close"></button>
        </div>
        <div id="map-container" style="width:100%; height:calc(100% - 75px);"></div>
      </div>
    </div>
  </div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrqjQGEg0cfGeF15NtfhZszL_PmagWfbdQ1-VqxMMiaTjDXXUHK8KSZWH-B64KDXSGMw/exec"; 

let currentUser=null, currentLat=null, currentLon=null, currentAcc=null, videoStream=null, mapInstance=null, officeSettings = { lat: 0, lon: 0, radius: 150, name: "Pending..." };

// --- 1. UTILITIES ---
function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3;
    const p1 = lat1 * Math.PI/180;
    const p2 = lat2 * Math.PI/180;
    const d1 = (lat2-lat1) * Math.PI/180;
    const d2 = (lon2-lon1) * Math.PI/180;
    const a = Math.sin(d1/2) * Math.sin(d1/2) + Math.cos(p1) * Math.cos(p2) * Math.sin(d2/2) * Math.sin(d2/2);
    return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
}

async function apiCall(data) {
    try {
        const res = await fetch(SCRIPT_URL, { method:'POST', redirect:'follow', headers:{'Content-Type':'text/plain;charset=utf-8'}, body:JSON.stringify(data) });
        return await res.json();
    } catch (e) { return {success:false, message:"Cloud link unstable. Check Internet."}; }
}

// --- 2. INITIALIZATION ---
window.onload = async function() {
  const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
  try {
    await Promise.all([ 
        faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL), 
        faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
        faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL),
        faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL) 
    ]);
    document.getElementById('global-loader').classList.add('hidden');
    const savedUser = localStorage.getItem('currentUser');
    if(savedUser) { currentUser = JSON.parse(savedUser); initDashboard(); }
  } catch(e) { console.error(e); document.getElementById('global-loader').classList.add('hidden'); }
  if (navigator.geolocation) navigator.geolocation.watchPosition(updatePosition, null, {enableHighAccuracy:true});
};

function updatePosition(pos) {
  currentLat=pos.coords.latitude; currentLon=pos.coords.longitude; currentAcc=pos.coords.accuracy;
  const msg = `GPS Lock: ±${Math.round(currentAcc)}m`;
  if(document.getElementById('admin-gps-status')) document.getElementById('admin-gps-status').innerText = msg;
  if(document.getElementById('worker-gps-status')) document.getElementById('worker-gps-status').innerText = msg;
  if(document.getElementById('btn-open-camera')) document.getElementById('btn-open-camera').disabled = false;
  if(document.getElementById('btn-set-loc') && currentUser?.role==='admin') document.getElementById('btn-set-loc').disabled=false;
}

// --- 3. AUTHENTICATION (FIXED) ---
function toggleAuth(showReg) {
    document.getElementById('login-form').classList.toggle('hidden', showReg);
    document.getElementById('register-form').classList.toggle('hidden', !showReg);
}

async function handleLogin() {
  const id=document.getElementById('login-id').value, pass=document.getElementById('login-pass').value;
  if(!id || !pass) return Swal.fire("Required", "Please provide all credentials.", "warning");
  
  Swal.fire({title:'Authenticating...', didOpen:()=>Swal.showLoading()});
  
  // FIX: Sending direct password to match backend logic
  const res = await apiCall({action:'login', id: id, password: pass});
  Swal.close();
  
  if(res.success) { 
      currentUser=res.user; 
      officeSettings.name = res.officeName || "Main HQ";
      officeSettings.lat = res.officeLat || 0;
      officeSettings.lon = res.officeLon || 0;
      localStorage.setItem('currentUser', JSON.stringify(currentUser)); 
      initDashboard(); 
  } else Swal.fire("Denied", res.message, "error");
}

async function handleRegister() {
    const name=document.getElementById('reg-name').value, mobile=document.getElementById('reg-mobile').value;
    if(!name || !mobile) return Swal.fire("Fields Missing", "Enrollment requires all data.", "warning");
    
    Swal.fire({title:'Enrolling Biometrics...', didOpen:()=>Swal.showLoading()});
    const res = await apiCall({action:'register', name, mobile, role:'Worker'});
    Swal.close();
    if(res.success) { 
        Swal.fire({icon: 'success', title: 'Enrollment Success', html: `ID: <b>${res.id}</b><br>Pass: <b>${res.pass}</b>`}); 
        toggleAuth(false); 
    }
}

async function handleForgotPass() {
    const {value: mobile} = await Swal.fire({title: 'Recover ID', input: 'number', inputLabel: 'Registered Mobile Number', showCancelButton: true});
    if (mobile) {
        Swal.fire({title:'Searching...', didOpen:()=>Swal.showLoading()});
        const res = await apiCall({action:'recoverPassword', mobile});
        Swal.close();
        res.success ? Swal.fire("Recovered", `Pass: ${res.password}`, "success") : Swal.fire("Error", res.message, "error");
    }
}

// --- 4. DASHBOARD & SHARED LOGIC ---
function initDashboard() {
    document.getElementById('auth-container').classList.add('hidden');
    document.getElementById('app-dashboard-container').classList.remove('hidden');
    const isAdmin = currentUser.role === 'admin';
    document.getElementById('admin-dashboard').classList.toggle('hidden', !isAdmin);
    document.getElementById('worker-dashboard').classList.toggle('hidden', isAdmin);
    
    const userImg = currentUser.profilePic || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
    if(isAdmin) {
        document.getElementById('admin-dp').src = userImg;
        document.getElementById('admin-welcome-note').innerText = `Admin Session: ${currentUser.name}`;
        loadAdminDashboard();
    } else {
        document.getElementById('worker-name-display').innerText = currentUser.name;
        document.getElementById('location-name-display').innerHTML = `Mark at: <b>${officeSettings.name}</b>`;
        document.getElementById('worker-dp').src = userImg;
        loadWorkerDashboard();
    }
}

async function loadAdminDashboard() {
  const data = await apiCall({action:'getAdminData'});
  const tbody = document.getElementById('admin-table-body'); tbody.innerHTML = "";
  data.forEach(r => {
      const uPic = r.userPic || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
      tbody.innerHTML += `
        <tr class="border-bottom">
            <td width="45"><img src="${uPic}" class="user-thumb"></td>
            <td><b>${r.name}</b><br><span class="text-muted">${r.date} | ${r.time}</span></td>
            <td><span class="status-badge status-${r.status}">${r.status}</span></td>
            <td class="text-end">
                <button onclick="viewFacePhoto('${r.image}')" class="btn btn-sm btn-light text-success me-1"><i class="fa fa-camera"></i></button>
                <button onclick="showMap(${r.lat}, ${r.lon}, '${r.name}')" class="btn btn-sm btn-light text-primary"><i class="fa fa-location-crosshairs"></i></button>
            </td>
        </tr>`;
  });
}

async function loadWorkerDashboard() {
  const data = await apiCall({action:'getWorkerHistory', userId:currentUser.id});
  document.getElementById('total-present').innerText = data.total;
  const tbody = document.getElementById('worker-history-body'); tbody.innerHTML = "";
  data.history.forEach(r => {
      const pic = currentUser.profilePic || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
      tbody.innerHTML += `
        <tr class="border-bottom">
            <td width="45"><img src="${pic}" class="user-thumb"></td>
            <td><b>${r.date}</b><br><span class="text-muted">${r.time}</span></td>
            <td><span class="status-badge status-${r.status}">${r.status}</span></td>
            <td class="text-end">
                <button onclick="viewFacePhoto('${r.image}')" class="btn btn-sm btn-light text-success me-1"><i class="fa fa-camera"></i></button>
                <button onclick="showMap(${r.lat}, ${r.lon}, '${r.status}')" class="btn btn-sm btn-light text-primary"><i class="fa fa-map-location-dot"></i></button>
            </td>
        </tr>`;
  });
}

// Other UI functions remain unchanged to maintain original features
function openAdminAddModal() { document.getElementById('admin-add-modal').classList.remove('hidden'); }
async function handleAdminAddUser() {
    const name = document.getElementById('admin-reg-name').value;
    const mobile = document.getElementById('admin-reg-mobile').value;
    const role = document.getElementById('admin-reg-role').value;
    if(!name || !mobile) return Swal.fire("Error", "Fill all details.", "error");
    Swal.fire({title:'Provisioning...', didOpen:()=>Swal.showLoading()});
    const res = await apiCall({action:'register', name, mobile, role});
    Swal.close();
    if(res.success) {
        document.getElementById('admin-add-modal').classList.add('hidden');
        Swal.fire("Account Created", `ID: ${res.id}\nPass: ${res.pass}`, "success");
        loadAdminDashboard();
    }
}

async function setOfficeLocation() {
    Swal.fire({title:'Locking HQ GPS...', didOpen:()=>Swal.showLoading()});
    const res = await apiCall({action:'updateOfficeLocation', lat:currentLat, lon:currentLon});
    Swal.close();
    if(res.success) { officeSettings.lat = currentLat; officeSettings.lon = currentLon; Swal.fire("Success", "Office Geofence Fixed!", "success"); }
}

async function setOfficeName() {
    const { value: name } = await Swal.fire({ title: 'Set Site Name', input: 'text', placeholder: 'e.g. Bihar Project Office', showCancelButton: true });
    if (name) {
        Swal.fire({title:'Syncing Name...', didOpen:()=>Swal.showLoading()});
        const res = await apiCall({action:'updateOfficeName', name: name});
        Swal.close();
        if(res.success) { officeSettings.name = name; Swal.fire("Success", "Name updated globally.", "success"); }
    }
}

function startCameraFlow() {
  const dist = calculateDistance(currentLat, currentLon, officeSettings.lat, officeSettings.lon);
  if(dist > officeSettings.radius) return Swal.fire("Out of Range", `Distance: ${Math.round(dist)}m. Please move closer to HQ.`, "error");
  document.getElementById('camera-overlay').classList.remove('hidden');
  const video = document.getElementById('video');
  navigator.mediaDevices.getUserMedia({video:{facingMode: "user"}}).then(s => {
      videoStream=s; video.srcObject=s; video.onloadedmetadata=() => { video.play(); checkLiveness(); };
  });
}

async function checkLiveness() {
  const video = document.getElementById('video'); const hint = document.getElementById('liveness-hint');
  const interval = setInterval(async () => {
    if(document.getElementById('camera-overlay').classList.contains('hidden')) { clearInterval(interval); return; }
    const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();
    if(detections.length===1) {
        if(detections[0].expressions.happy > 0.6) {
            hint.innerText="✓ IDENTITY VERIFIED"; hint.className = "position-absolute bottom-0 w-100 p-3 bg-success text-white fw-bold"; 
            clearInterval(interval); captureAndSubmit();
        } else { hint.innerText="Please SMILE for validation"; }
    } else { hint.innerText="Align Face in Center"; }
  }, 450);
}

async function captureAndSubmit() {
  const video=document.getElementById('video'), canvas=document.createElement('canvas');
  canvas.width=320; canvas.height=240; canvas.getContext('2d').drawImage(video,0,0, 320, 240);
  const base64=canvas.toDataURL('image/jpeg', 0.6); stopCamera();
  Swal.fire({title:'Syncing Biometric Log...', didOpen:()=>Swal.showLoading()});
  const res = await apiCall({action:'markAttendance', userId:currentUser.id, name:currentUser.name, lat:currentLat, lon:currentLon, image:base64});
  res.success ? (Swal.fire("Verified!", "Entry synchronized successfully.", "success"), loadWorkerDashboard()) : Swal.fire("Failed", res.message, "error");
}

function viewFacePhoto(url) {
    if(!url || url === '-' || url === 'undefined') return Swal.fire("No Photo", "Snapshot was not enabled.", "info");
    document.getElementById('modal-photo-img').src = url;
    document.getElementById('photo-modal').classList.remove('hidden');
}

function showMap(lat, lon, title) {
  document.getElementById('map-modal').classList.remove('hidden');
  setTimeout(() => {
    if (mapInstance) mapInstance.remove();
    mapInstance = L.map('map-container').setView([lat, lon], 17);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapInstance);
    L.marker([lat, lon]).addTo(mapInstance).bindPopup(`<b>${title}</b>`).openPopup();
  }, 350);
}

function uploadProfilePic(input) {
  if(input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = async function(e) {
          const base64 = e.target.result;
          const targetID = currentUser.role === 'admin' ? 'admin-dp' : 'worker-dp';
          document.getElementById(targetID).src = base64;
          Swal.fire({title:'Saving Avatar...', didOpen:()=>Swal.showLoading()});
          const res = await apiCall({action:'updateProfileImage', userId:currentUser.id, image:base64});
          Swal.close();
          if(res.success) { 
              currentUser.profilePic = res.newUrl || base64;
              localStorage.setItem('currentUser', JSON.stringify(currentUser));
              Swal.fire({icon:'success', title:'Saved', position:'top-end', toast:true, timer:2000}); 
          }
      };
      reader.readAsDataURL(input.files[0]);
  }
}

function downloadReport() {
    Swal.fire({title:'Generating Archive...', didOpen:()=>Swal.showLoading()});
    apiCall({action:'exportData'}).then(res => {
        Swal.close();
        if(res.success) {
            const blob = new Blob([res.csvData], {type:'text/csv'});
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href=url; a.download="Log_Enterprise.csv"; a.click();
        }
    });
}

function stopCamera() { if(videoStream) videoStream.getTracks().forEach(t=>t.stop()); document.getElementById('camera-overlay').classList.add('hidden'); }
function logout() { localStorage.removeItem('currentUser'); location.reload(); }

</script>
</body>
          </html>
